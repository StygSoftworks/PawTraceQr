const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jszip-AKCedKK4.js","assets/forms-BenlWNMe.js","assets/pdf-export-BgTFhrNl.js","assets/pdf-DO90N-Wx.js"])))=>i.map(i=>d[i]);
import{j as e}from"./radix-ui-Bptolu_l.js";import{r as u}from"./forms-BenlWNMe.js";import{u as V,c as Y}from"./react-query-DgYD4zqU.js";import{u as ee}from"./useAdminCheck-Cc2fRG8A.js";import{_ as J}from"./pdf-DO90N-Wx.js";import{s as I}from"./index-Dd9VGw46.js";import{m as D,a as L}from"./qr-BoV9QW4R.js";import{d as y,b as v,a as _,C as w,c as Q}from"./card-B15pueGN.js";import{B as N}from"./button-CF7bJTeZ.js";import{L as b,I as se}from"./input-ncIFNCOj.js";import{B as te}from"./badge-loPPs1rg.js";import{S as $,a as R,b as q,c as A,d as x}from"./select-D-VmZLLO.js";import{A as F,a as z}from"./alert-BxnlJauh.js";import{h as Z,a6 as k,F as ae,a7 as re,a8 as le,a9 as ne}from"./icons-BE4ufEBC.js";import"./react-dom-CWqaeSHD.js";import"./supabase-Dq_AJ6PJ.js";import"./router-fBLXKt6a.js";import"./opentype-CPIVssqb.js";import"./utils-CBfrqCZ4.js";import"./index-CdJFUDDL.js";async function G(t=null,s=100,r=0){const{data:a,error:c}=await I.rpc("get_available_qr_codes",{p_limit:s,p_offset:r,p_tag_type:t});if(c)throw c;return a||[]}async function M(t){const{data:s,error:r}=await I.rpc("get_qr_code_by_shortid",{p_short_id:t});if(r)throw r;return s?.[0]||null}async function ie(){const{data:t,error:s}=await I.rpc("get_qr_pool_stats");if(s)throw s;return t?.[0]||null}async function oe(t){const{tag_type:s,shortcodes:r,limit:a=100}=t;if(r&&r.length>0){const c=[];for(const i of r){const o=await M(i);o&&c.push(o)}return c}else return await G(s||null,a,0)}async function W(){return(await J(async()=>{const{default:s}=await import("./jszip-AKCedKK4.js").then(r=>r.j);return{default:s}},__vite__mapDeps([0,1]))).default}async function ce(t){const s=await oe(t);if(s.length===0)throw new Error("No QR codes found matching criteria");return(t.format||"svg")==="pdf"?await de(s,t):await xe(s,t)}async function de(t,s){const[r,{svgStringToPdf:a}]=await Promise.all([W(),J(()=>import("./pdf-export-BgTFhrNl.js"),__vite__mapDeps([2,3,1]))]),c="https://www.pawtraceqr.com/p/",i=new r;for(const l of t){const g=`${c}${l.short_id}`,d=`pawtraceqr.com/p/${l.short_id}`;let f;s.shape==="round"?f=await D(g,d,512,!1):f=await L(g,d,512,!1);const E=await a(f,{pageSize:s.pdfPageSize||"letter",orientation:"portrait",title:`${l.tag_type.toUpperCase()} QR Code - ${l.short_id}`,author:"PawTrace QR Admin",targetWidth:144}),C=`${l.tag_type}-${l.short_id}.pdf`;i.file(C,E)}const o={exported_at:new Date().toISOString(),shape:s.shape,tag_type:s.tag_type||"all",format:"pdf",page_size:s.pdfPageSize||"letter",count:t.length,codes:t.map(l=>({short_id:l.short_id,tag_type:l.tag_type,filename:`${l.tag_type}-${l.short_id}.pdf`}))};return i.file("manifest.json",JSON.stringify(o,null,2)),await i.generateAsync({type:"blob"})}async function xe(t,s){const r=await W(),a=new r,c="https://www.pawtraceqr.com/p/";for(const o of t){const l=`${c}${o.short_id}`,g=`pawtraceqr.com/p/${o.short_id}`;let d;s.shape==="round"?d=await D(l,g):d=await L(l,g);const f=`${o.tag_type}-${o.short_id}.svg`;a.file(f,d)}const i={exported_at:new Date().toISOString(),shape:s.shape,tag_type:s.tag_type||"all",format:"svg",count:t.length,codes:t.map(o=>({short_id:o.short_id,tag_type:o.tag_type,filename:`${o.tag_type}-${o.short_id}.svg`}))};return a.file("manifest.json",JSON.stringify(i,null,2)),await a.generateAsync({type:"blob"})}function he(t,s){const r=URL.createObjectURL(t),a=document.createElement("a");a.href=r,a.download=s,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)}async function me(t){const s=await ce(t),r=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5),a=t.tag_type||"all",c=`qr-codes-${t.shape}-${a}-${r}.zip`;he(s,c)}function Ae(){const{role:t,isAdmin:s,isLoading:r}=ee(),[a,c]=u.useState("square"),[i,o]=u.useState("all"),[l,g]=u.useState(""),[d,f]=u.useState(10),[E,C]=u.useState(null),[m,U]=u.useState("svg"),[P,H]=u.useState("letter"),{data:h}=V({queryKey:["qr-pool-stats"],queryFn:ie,staleTime:3e4,enabled:s}),{data:j}=V({queryKey:["available-qr-codes",i,d],queryFn:()=>G(i==="all"?null:i,d,0),staleTime:3e4,enabled:s&&!l}),p=Y({mutationFn:async n=>{await me(n)}});u.useEffect(()=>{async function n(){if(!j||j.length===0){C(null);return}const S=j[0],B=`https://www.pawtraceqr.com/p/${S.short_id}`,O=`pawtraceqr.com/p/${S.short_id}`;try{let T;a==="round"?T=await D(B,O,256):T=await L(B,O,256),C(T)}catch(T){console.error("Preview generation error:",T),C(null)}}n()},[a,j]);const K=async()=>{if(l)try{const n=await M(l);if(!n){alert("QR code not found or already assigned");return}if(n.is_assigned){alert("This QR code is already assigned to a pet");return}await p.mutateAsync({shape:a,tag_type:n.tag_type,shortcodes:[l],format:m,pdfPageSize:P})}catch(n){const S=n instanceof Error?n.message:"Unknown error";alert(`Export failed: ${S}`)}},X=async()=>{try{await p.mutateAsync({shape:a,tag_type:i==="all"?null:i,limit:d,format:m,pdfPageSize:P})}catch(n){const S=n instanceof Error?n.message:"Unknown error";alert(`Export failed: ${S}`)}};return r?e.jsx("div",{className:"container mx-auto px-4 sm:px-6 py-10 md:py-14 max-w-7xl",children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading..."})}):s?e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 py-10 md:py-14 max-w-7xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold tracking-tight mb-2",children:"QR Code Export"}),e.jsx("p",{className:"text-muted-foreground",children:"Export available QR codes for manufacturing"})]}),e.jsx(te,{variant:"default",children:t})]}),h&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs(y,{children:[e.jsx(v,{className:"pb-3",children:e.jsx(_,{className:"text-sm font-medium",children:"Dog Tags Available"})}),e.jsxs(w,{children:[e.jsx("div",{className:"text-2xl font-bold",children:h.unassigned_dog_count}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[h.total_dog_count," total"]})]})]}),e.jsxs(y,{children:[e.jsx(v,{className:"pb-3",children:e.jsx(_,{className:"text-sm font-medium",children:"Cat Tags Available"})}),e.jsxs(w,{children:[e.jsx("div",{className:"text-2xl font-bold",children:h.unassigned_cat_count}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[h.total_cat_count," total"]})]})]}),e.jsxs(y,{children:[e.jsx(v,{className:"pb-3",children:e.jsx(_,{className:"text-sm font-medium",children:"Total Available"})}),e.jsxs(w,{children:[e.jsx("div",{className:"text-2xl font-bold",children:h.unassigned_dog_count+h.unassigned_cat_count}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ready for export"})]})]}),e.jsxs(y,{children:[e.jsx(v,{className:"pb-3",children:e.jsx(_,{className:"text-sm font-medium",children:"Total Assigned"})}),e.jsxs(w,{children:[e.jsx("div",{className:"text-2xl font-bold",children:h.assigned_dog_count+h.assigned_cat_count}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"In use by pets"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(y,{children:[e.jsxs(v,{children:[e.jsx(_,{children:"Export Settings"}),e.jsx(Q,{children:"Configure QR code export parameters"})]}),e.jsxs(w,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Export Format"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{variant:m==="svg"?"default":"outline",onClick:()=>U("svg"),className:"flex-1",children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"SVG (ZIP)"]}),e.jsxs(N,{variant:m==="pdf"?"default":"outline",onClick:()=>U("pdf"),className:"flex-1",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"PDF"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Shape"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{variant:a==="square"?"default":"outline",onClick:()=>c("square"),className:"flex-1",children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Square"]}),e.jsxs(N,{variant:a==="round"?"default":"outline",onClick:()=>c("round"),className:"flex-1",children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),"Circle"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"tag-type",children:"Tag Type"}),e.jsxs($,{value:i,onValueChange:n=>o(n),children:[e.jsx(R,{id:"tag-type",children:e.jsx(q,{})}),e.jsxs(A,{children:[e.jsx(x,{value:"all",children:"All Types"}),e.jsx(x,{value:"dog",children:"Dog Tags Only"}),e.jsx(x,{value:"cat",children:"Cat Tags Only"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"batch-size",children:"Batch Size"}),e.jsxs($,{value:String(d),onValueChange:n=>f(Number(n)),children:[e.jsx(R,{id:"batch-size",children:e.jsx(q,{})}),e.jsxs(A,{children:[e.jsx(x,{value:"10",children:"10 codes"}),e.jsx(x,{value:"25",children:"25 codes"}),e.jsx(x,{value:"50",children:"50 codes"}),e.jsx(x,{value:"200",children:"200 codes"}),e.jsx(x,{value:"100",children:"100 codes"}),e.jsx(x,{value:"500",children:"500 codes"})]})]})]}),m==="pdf"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"pdf-page-size",children:"PDF Page Size"}),e.jsxs($,{value:P,onValueChange:n=>H(n),children:[e.jsx(R,{id:"pdf-page-size",children:e.jsx(q,{})}),e.jsxs(A,{children:[e.jsx(x,{value:"letter",children:"Letter (8.5 × 11 in)"}),e.jsx(x,{value:"a4",children:"A4 (210 × 297 mm)"})]})]})]}),e.jsx("div",{className:"pt-4",children:e.jsxs(N,{onClick:X,disabled:!j||j.length===0||p.isPending,className:"w-full",size:"lg",children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),p.isPending?"Exporting...":`Export ${j?.length||0} Codes`]})})]})]}),e.jsxs(y,{children:[e.jsxs(v,{children:[e.jsx(_,{children:"Export Single Code"}),e.jsx(Q,{children:"Export a specific QR code by shortcode"})]}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"shortcode",children:"Shortcode"}),e.jsx(se,{id:"shortcode",placeholder:"Enter shortcode (e.g., abc123)",value:l,onChange:n=>g(n.target.value)})]}),e.jsxs(N,{onClick:K,disabled:!l||p.isPending,className:"w-full",children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Export Single Code"]})]})]}),p.isSuccess&&e.jsxs(F,{children:[e.jsx(ne,{className:"h-4 w-4"}),e.jsx(z,{children:"QR codes exported successfully! Check your downloads folder."})]}),p.isError&&e.jsxs(F,{variant:"destructive",children:[e.jsx(Z,{className:"h-4 w-4"}),e.jsxs(z,{children:["Export failed: ",p.error?.message]})]})]}),e.jsx("div",{children:e.jsxs(y,{children:[e.jsxs(v,{children:[e.jsx(_,{children:"Preview"}),e.jsx(Q,{children:"Sample QR code with text label"})]}),e.jsxs(w,{children:[E?e.jsx("div",{className:"w-full flex items-center justify-center p-4 bg-gray-50 rounded-lg",dangerouslySetInnerHTML:{__html:E}}):e.jsx("div",{className:"w-full h-64 flex items-center justify-center bg-gray-50 rounded-lg text-muted-foreground",children:"No preview available"}),e.jsxs("div",{className:"mt-4 space-y-2 text-sm text-muted-foreground",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Shape:"})," ",a==="square"?"Square":"Circle"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Text Position:"})," ",a==="square"?"Flat below QR code":"Curved along bottom"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Format:"})," ",m==="pdf"?`PDF ZIP (${P.toUpperCase()})`:"SVG ZIP (Illustrator compatible)"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Files:"})," ",m==="pdf"?"Individual PDF per QR code":"Individual SVG per QR code"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Naming:"})," ",i==="all"?"dog/cat":i,"-shortcode.",m==="pdf"?"pdf":"svg"]})]})]})]})})]})]}):e.jsx("div",{className:"container mx-auto px-4 sm:px-6 py-10 md:py-14 max-w-7xl",children:e.jsxs(F,{variant:"destructive",children:[e.jsx(Z,{className:"h-4 w-4"}),e.jsx(z,{children:"Access denied. This page is only accessible to administrators."})]})})}export{Ae as default};
